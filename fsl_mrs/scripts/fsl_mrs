#!/usr/bin/env python

# fsl_mrs - wrapper script for MRS fitting
#
# Author: Saad Jbabdi <saad@fmrib.ox.ac.uk>
#
# Copyright (C) 2019 University of Oxford 
# SHBASECOPYRIGHT

# Quick imports
#import argparse
import configargparse

from fsl_mrs import __version__
from fsl_mrs.utils.splash import splash

# NOTE!!!! THERE ARE MORE IMPORTS IN THE CODE BELOW (AFTER ARGPARSING)



def main():
    # Parse command-line arguments
    p = configargparse.ArgParser(add_config_file_help=False,description="FSL Magnetic Resonance Spectroscopy Wrapper Script")


    # utility for hiding certain arguments
    def hide_args(arglist):
        for action in arglist:
            action.help=p.SUPPRESS

        
    #p = argparse.ArgumentParser(description='FSL Magnetic Resonance Spectroscopy Tool')
    p.add_argument('-v','--version', action='version', version=__version__)
    
    required     = p.add_argument_group('required arguments')
    fitting_args = p.add_argument_group('fitting options')
    optional     = p.add_argument_group('additional options')

    # REQUIRED ARGUMENTS
    required.add_argument('--data',
                          required=True,type=str,metavar='<str>.RAW',
                          help='input FID file')
    required.add_argument('--basis',
                          required=True,type=str,metavar='<str>',
                          help='.BASIS file or folder containing basis spectra (will read all .RAW files within)')
    required.add_argument('--output',
                          required=True,type=str,metavar='<str>',
                          help='output folder')
    
    # FITTING ARGUMENTS
    fitting_args.add_argument('--algo',default='Newton',type=str,
                   help='algorithm [Newton (fast) or MH (slow)]')
    fitting_args.add_argument('--ignore',type=str,nargs='+',metavar='METAB',
                   help='ignore certain metabolites [repeatable]')
    fitting_args.add_argument('--keep',type=str,nargs='+',metavar='METAB',
                   help='only keep these metabolites')
    fitting_args.add_argument('--combine',type=str,nargs='+',action='append',metavar='METAB',
                   help='combine certain metabolites [repeatable]')
    fitting_args.add_argument('--ppmlim',default=(.2,4.2),type=float,nargs=2,metavar=('LOW','HIGH'),
                   help='limit the fit to a freq range (default=(.2,4.2))')
    fitting_args.add_argument('--h2o',type=str,metavar='H2O',
                   help='input .H2O file for quantification')
    fitting_args.add_argument('--baseline_order',default=2,type=int,metavar=('ORDER'),
                   help='order of baseline polynomial (default=2)')
    fitting_args.add_argument('--metab_groups',default=0,nargs='+',type=int,
                              help="metabolite groups")
    fitting_args.add_argument('--add_MM',type=bool,
                              help="include default macromolecule peaks")

    
    
    # ADDITONAL OPTIONAL ARGUMENTS
    optional.add_argument('--central_frequency',default=None,type=float,
                           help='central frequency in Hz')
    optional.add_argument('--dwell_time',default=None,type=float,
                           help='dwell time in seconds')
    optional.add_argument('--report',action="store_true",
                          help='output html report')
    optional.add_argument('--verbose',action="store_true",
                          help='spit out verbose info')
    optional.add_argument('--overwrite',action="store_true",
                          help='overwrite existing output folder')
    optional.add('--config', required=False, is_config_file=True, help='configuration file')


    #hide_args([h1,h2])
    
    # Parse command-line arguments
    args = p.parse_args()

    # Output kickass splash screen
    if args.verbose:
        splash(logo='mrs')


    # ######################################################
    # DO THE IMPORTS AFTER PARSING TO SPEED UP HELP DISPLAY
    import time, os, sys, shutil, warnings
    import numpy as np
    from fsl_mrs.core import MRS
    from fsl_mrs.utils import mrs_io
    from fsl_mrs.utils import report
    from fsl_mrs.utils import fitting
    from fsl_mrs.utils import plotting
    from fsl_mrs.utils import misc
    import datetime
    import plotly
    # ######################################################

    
    # Check if output folder exists
    overwrite = args.overwrite
    if os.path.exists(args.output):
        if not overwrite:
            print("Folder '{}' exists. Are you sure you want to delete it? [Y,N]".format(args.output))
            response = input()
            overwrite = response.upper() == "Y"
        if not overwrite:
            print('Early stopping...')
            exit()
        else:
            shutil.rmtree(args.output)
            os.mkdir(args.output)
    else:
        os.mkdir(args.output)


    # Save chosen arguments
    with open(os.path.join(args.output,"options.txt"),"w") as f:
        f.write(str(args))
        f.write("\n--------\n")
        f.write(p.format_values())
        
        
    #######  Do the work #######

    # Read data/h2o/basis    
    FID,dataheader            = mrs_io.read_FID(args.data)
    basis, names, basisheader = mrs_io.read_basis(args.basis)
    if args.h2o is not None:
        H2O,_                 = mrs_io.read_FID(args.h2o)
    else:
        H2O = None

    # Collect useful info
    if args.central_frequency is not None:
        cf = args.central_frequency
    elif dataheader['centralFrequency'] is not None:
        cf = dataheader['centralFrequency']
    else:
        raise(Exception('Cannot determine central frequency. Please either set it on include it in data header'))

    if args.dwell_time is not None:
        bw = 1/args.dwell_time
    elif dataheader['bandwidth'] is not None:
        bw = dataheader['bandwidth']
    else:
        raise(Exception('Cannot determine central frequency. Please either set it on include it in data header'))

        
    # Resample basis?
    if bw != basisheader['bandwidth']:
        dwell     = 1/basisheader['bandwidth']
        new_dwell = 1/bw
        basis     = misc.resample_ts(basis,dwell,new_dwell)


    # Instantiate MRS object
    MRSargs = {'FID':FID,'basis':basis,'names':names,'H2O':H2O,'cf':cf,'bw':bw}
    mrs     = MRS(**MRSargs)
    
    # Check the FID
    mrs.check_FID(repare=True)

    # Do phase correction
    mrs.FID  = misc.phase_correct(mrs.FID)
    mrs.Spec = np.fft.fft(mrs.FID)
  
    if args.verbose:        
        print('--->> Read input data and basis\n')
        print('  {}\n'.format(args.data))
        print('  {}\n'.format(args.basis))

            
        
    # Keep/Ignore/Combine metabolites
    mrs.keep(args.keep)
    mrs.ignore(args.ignore)
    mrs.combine(args.combine)

    
    # Do the fitting here
    if args.verbose:
        print('--->> Start fitting\n\n')
        print('    Algorithm = [{}]\n'.format(args.algo))
        start = time.time()

        
    # Do the fitting
    print('     --- Run fitting --- ')
    ppmlim=args.ppmlim
    if ppmlim is not None:
        ppmlim=(ppmlim[0],ppmlim[1])
 
    #mrs.fit(model = args.model, method=args.algo,ppmlim=args.ppmlim)


    # Parse metabolite groups
    metab_groups = args.metab_groups
    if metab_groups == 0:
        metab_groups = [0]*mrs.numBasis
    if len(metab_groups) != mrs.numBasis:
        raise(Exception('Found {} metab_groups but there are {} basis functions'.format(len(metab_groups),mrs.numBasis)))

    # Include Macromolecules? These should have their own metab groups
    if args.add_MM is not None:
        nMM = mrs.add_MM_peaks()
        G   = [i+max(metab_groups)+1 for i in range(nMM)]
        metab_groups += G


    Fitargs = {'mrs':mrs,'ppmlim':ppmlim,
               'method':args.algo,'baseline_order':args.baseline_order,
               'metab_groups':metab_groups}

    res = fitting.fit_FSLModel(**Fitargs)


    
    stop = time.time()

    
    # Report on the fitting
    if args.verbose:
        print('    Fitting lasted          : {:.3f} secs.\n'.format(stop-start))
        #print('    Fitted concentrations   : {}\n'.format(mrs.concentrations))
    # Save output files
    if args.verbose:
        print('--->> Saving output files to {}\n'.format(args.output))


    res.to_file(mrs,filename=os.path.join(args.output,'results_table.csv'))
    


    # Create short HTML report
    #fig = plotting.plotly_fit(mrs,res,ppmlim=ppmlim,proj='abs')
    #plotly.io.write_html(fig, file=os.path.join(args.output,'short_report.html'))
    
    
    
    # Creat HTML report
    report.create_report(mrs,res,
                         filename=os.path.join(args.output,'report.html'),
                         fidfile=args.data,
                         basisfile=args.basis,
                         h2ofile=args.h2o,
                         outdir=args.output,
                         date=datetime.datetime.now().strftime("%Y-%m-%d %H:%M"))
                         

    report.fitting_summary_fig(mrs,res,
                               filename=os.path.join(args.output,'fit_summary.png'))
     
    if args.verbose:
        print('\n\n\nDone.')

        
if __name__ == '__main__':
    main()
